# Update Files Table ID to UUID

## Overview

This migration changes the primary key of the `files` table from an auto-incrementing integer to a UUID. This change provides several benefits:

1. **Globally unique identifiers**: UUIDs are globally unique, making them ideal for distributed systems
2. **Security**: UUIDs don't expose sequential numbering that could reveal information about your data volume
3. **Consistency**: Aligns with other tables in the system that use UUIDs as primary keys
4. **Scalability**: Better for sharding and distributed databases

## Changes

The migration performs the following changes:

1. Drops existing constraints and indexes
2. Renames the existing `uuid` column to `id_uuid` temporarily
3. Renames the existing `id` column to `id_old`
4. Creates a new `id` column of type UUID
5. Copies values from `id_uuid` to `id` for existing records
6. Drops the temporary `id_uuid` column
7. Adds the primary key constraint to the new `id` column
8. Re-adds foreign key constraints and indexes
9. Drops the old `id_old` column
10. Updates the `soft_delete_file` and `restore_deleted_file` functions to use UUID

## Impact

This change affects:

- The `fileService` in the application code, which needs to be updated to handle UUID IDs
- Any API endpoints that reference file IDs
- Any database queries that directly reference the `files` table

## Implementation Date

March 13, 2025

## Related Code Changes

The following files need to be updated to work with UUID file IDs:

1. `packages/server/src/services/file.ts`
2. `packages/server/src/controllers/assetsController.ts`

## Rollback Plan

If issues are encountered, the following rollback SQL can be used:

```sql
-- Rollback: Revert files table to use integer ID
ALTER TABLE public.files ADD COLUMN id_int BIGINT GENERATED BY DEFAULT AS IDENTITY;
ALTER TABLE public.files DROP CONSTRAINT files_pkey;
ALTER TABLE public.files ADD CONSTRAINT files_pkey PRIMARY KEY (id_int);
ALTER TABLE public.files RENAME COLUMN id TO uuid;
ALTER TABLE public.files RENAME COLUMN id_int TO id;

-- Revert functions
CREATE OR REPLACE FUNCTION public.soft_delete_file(file_id BIGINT)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  UPDATE public.files
  SET is_deleted = TRUE
  WHERE id = file_id
  AND (
    created_by = auth.uid() OR
    authorize('platform.admin'::text) OR
    (context_type = 'application'::text AND authorize_resource('file.delete'::text, 'application'::text, context_id)) OR
    (context_type = 'organization'::text AND authorize_resource('file.delete'::text, 'organization'::text, context_id))
  );
  
  RETURN FOUND;
END;
$$;

CREATE OR REPLACE FUNCTION public.restore_deleted_file(file_id BIGINT)
RETURNS BOOLEAN
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  UPDATE public.files
  SET is_deleted = FALSE
  WHERE id = file_id
  AND (
    created_by = auth.uid() OR
    authorize('platform.admin'::text) OR
    (context_type = 'application'::text AND authorize_resource('file.update'::text, 'application'::text, context_id)) OR
    (context_type = 'organization'::text AND authorize_resource('file.update'::text, 'organization'::text, context_id))
  );
  
  RETURN FOUND;
END;
$$;
``` 