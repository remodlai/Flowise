# Path Tokens and URLs in Supabase Storage Integration

## Overview

Our file storage system uses two key components to manage and access files:

1. **Public URLs**: Direct links to access files, used for displaying or downloading content
2. **Path Tokens**: Array representation of hierarchical paths, used for organization and navigation

Understanding how these components work together is essential for effectively using the file storage system.

## Public URLs

### Purpose and Usage

Public URLs serve as direct access points to files stored in Supabase Storage. They are used for:

- Displaying images in the UI (setting as `src` attributes)
- Providing download links to files
- Embedding media in applications
- Direct API access to file content

### Structure

A typical public URL has the following structure:
```
https://[project-ref].supabase.co/storage/v1/object/public/[bucket]/[path]/[filename]
```

For example:
```
https://voksjtjrshonjadwjozt.supabase.co/storage/v1/object/public/platform/test/images/test_circle.svg
```

### Generation

Public URLs are automatically generated by the file service using:
1. The bucket name
2. The path constructed from path tokens
3. The filename

The implementation uses Supabase's `getPublicUrl` helper function:

```typescript
const { data: urlData } = supabase.storage.from(bucket).getPublicUrl(path_tokens.join('/') + '/' + filename);
const url = urlData?.publicUrl;
```

## Path Tokens

### Purpose and Usage

Path tokens represent the hierarchical organization of files as an array of path segments. They are used for:

- Creating folder-like organization in the flat storage system
- Building navigation breadcrumbs in the UI
- Filtering and querying files by path segments
- Constructing complete file paths for storage operations

### Structure

Path tokens are stored as a text array in the database:

```typescript
path_tokens: ["folder1", "subfolder", "category"]
```

For a file stored at `folder1/subfolder/category/file.jpg`, the path tokens would be:
```
["folder1", "subfolder", "category"]
```

### Benefits Over String Paths

Using an array of path tokens instead of a single string path provides several advantages:

1. **Efficient Querying**: Allows for efficient database queries like:
   ```sql
   WHERE path_tokens[1] = 'folder1'
   ```

2. **Hierarchical Navigation**: Makes it easy to navigate up and down the folder hierarchy:
   ```typescript
   // Navigate up one level
   const parentPath = pathTokens.slice(0, -1);
   
   // Navigate to a specific level
   const levelPath = pathTokens.slice(0, level);
   ```

3. **Breadcrumb Generation**: Simplifies creating UI breadcrumbs:
   ```jsx
   {pathTokens.map((token, index) => (
     <Breadcrumb.Item key={index} onClick={() => navigateToPath(pathTokens.slice(0, index + 1))}>
       {token}
     </Breadcrumb.Item>
   ))}
   ```

## Integration in the UI

### Displaying Files

When displaying files in the UI, use the public URL directly:

```jsx
<img src={file.url} alt={file.name} />
```

### Building Navigation

When building navigation components, use the path tokens:

```jsx
// Breadcrumb navigation
const BreadcrumbNav = ({ pathTokens, onNavigate }) => (
  <Breadcrumb>
    <Breadcrumb.Item onClick={() => onNavigate([])}>Root</Breadcrumb.Item>
    {pathTokens.map((token, index) => (
      <Breadcrumb.Item 
        key={index} 
        onClick={() => onNavigate(pathTokens.slice(0, index + 1))}
      >
        {token}
      </Breadcrumb.Item>
    ))}
  </Breadcrumb>
);

// Folder tree
const buildFolderTree = (files) => {
  const tree = {};
  
  files.forEach(file => {
    let current = tree;
    file.path_tokens.forEach(token => {
      current[token] = current[token] || { files: [], folders: {} };
      current = current[token].folders;
    });
    current.files.push(file);
  });
  
  return tree;
};
```

## Best Practices

1. **Always Use Path Tokens for Organization**: 
   - When uploading files, always specify appropriate path tokens
   - Use consistent naming conventions for path tokens

2. **Use Public URLs for Display**:
   - Always use the generated public URL for displaying or linking to files
   - Don't attempt to construct URLs manually

3. **Hierarchical Organization**:
   - Create logical hierarchies with path tokens (e.g., `["organizations", orgId, "documents"]`)
   - Keep path token arrays reasonably short (3-5 levels) for usability

4. **UI Considerations**:
   - Display user-friendly names in breadcrumbs (e.g., organization name instead of ID)
   - Provide clear visual indicators of the current location in the hierarchy

## Example Implementation

```typescript
// Uploading a file with path tokens
const uploadFile = async (file, organizationId, category) => {
  const pathTokens = ["organizations", organizationId, category];
  
  const result = await api.post('/api/v1/platform/assets/images/upload', {
    file,
    pathTokens,
    contextType: 'organization',
    contextId: organizationId,
    description: file.name,
    isPublic: true
  });
  
  return result.data;
};

// Displaying files with breadcrumb navigation
const FileExplorer = ({ organizationId, files }) => {
  const [currentPath, setCurrentPath] = useState([]);
  
  // Filter files by current path
  const filteredFiles = files.filter(file => {
    if (currentPath.length === 0) return file.path_tokens.length === 0;
    
    // Check if file path starts with current path
    return currentPath.every((token, index) => 
      file.path_tokens[index] === token
    );
  });
  
  return (
    <div>
      <Breadcrumb>
        <Breadcrumb.Item onClick={() => setCurrentPath([])}>Root</Breadcrumb.Item>
        {currentPath.map((token, index) => (
          <Breadcrumb.Item 
            key={index} 
            onClick={() => setCurrentPath(currentPath.slice(0, index + 1))}
          >
            {token}
          </Breadcrumb.Item>
        ))}
      </Breadcrumb>
      
      <div className="files-grid">
        {filteredFiles.map(file => (
          <div key={file.id} className="file-card">
            <img src={file.url} alt={file.name} />
            <p>{file.name}</p>
          </div>
        ))}
      </div>
    </div>
  );
};
```

By leveraging both public URLs and path tokens appropriately, we can create a powerful and intuitive file management system that provides both direct access to files and logical organization. 