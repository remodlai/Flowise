# Endpoint Analysis: POST /api/v1/leads/

**Module:** `leads`

**Operation ID:** `internalLeadsCreate`

**Description:** Creates a new lead record, typically captured from a chat session, associating it with a chatflow and a specific chat ID.

**Key Files:**
*   **Router:** `packages/server/src/routes/leads/index.ts`
*   **Controller:** `packages/server/src/controllers/leads/index.ts` (Handler: `createLeadInChatflow`)
*   **Service:** `packages/server/src/services/leads/index.ts` (Method: `createLead`)
*   **Entity:** `packages/server/src/database/entities/Lead.ts`
*   **Interface:** `packages/server/src/Interface.ts` (Interface: `ILead`)

**Authentication:** Requires API Key.

**Request Body (`application/json`):**
*   `chatflowid` (string, format: uuid, required): ID of the chatflow this lead is associated with.
*   `chatId` (string, optional): ID of the chat session from which this lead was generated. If not provided, a new UUID will be generated.
*   `name?` (string, optional): Name of the lead.
*   `email?` (string, optional, format: email): Email address of the lead.
*   `phone?` (string, optional): Phone number of the lead.
*   *(Note: `id` and `createdDate` are auto-generated by the system.)*

*   **Example Request Body:**
    ```json
    {
      "chatflowid": "abc-123-def-456",
      "chatId": "xyz-789-uvw-012",
      "name": "John Doe",
      "email": "john.doe@example.com"
    }
    ```

**Responses:**

*   **`200 OK` (Success):**
    *   **Description:** Lead created successfully. Returns the created `Lead` entity.
    *   **Content (`application/json`):** 
        *   Schema based on `Lead` entity with the following properties:
            * `id` (string, uuid): Unique identifier of the lead record (generated by the server).
            * `name?` (string, optional): Name of the lead.
            * `email?` (string, optional): Email address of the lead.
            * `phone?` (string, optional): Phone number of the lead.
            * `chatflowid` (string): ID of the chatflow where the lead was captured.
            * `chatId` (string): ID of the specific chat session that generated the lead (provided or generated).
            * `createdDate` (string, date-time): Timestamp when the lead was created (generated by the server).
*   **`412 Precondition Failed`:**
    *   **Description:** If `req.body` is not provided.
    *   **Content (`application/json`):** Error response with message about missing body.
*   **`400 Bad Request`:**
    *   **Description:** If essential fields like `chatflowid` are missing or invalid.
    *   **Content (`application/json`):** Error response with validation details.
*   **`500 Internal Server Error`:**
    *   **Description:** Database error or other server-side issue during lead creation.
    *   **Content (`application/json`):** Error response with details about the issue.

**Core Logic Summary:**
1. Controller (`createLeadInChatflow`) checks for `req.body` and returns 412 error if missing.
2. Calls `leadsService.createLead(req.body)`.
3. Service (`createLead`):
   * Extracts body properties.
   * If `chatId` is not provided, generates a new UUID.
   * Creates a new `Lead` entity instance with the provided properties.
   * Saves the entity to the database.
   * Returns the saved entity with all fields (including generated ones).
4. Controller returns the service response as JSON.

**Implementation Notes:**
* This endpoint enables capturing lead information during chat sessions, allowing for follow-up by sales or marketing teams.
* The endpoint accepts various lead contact information, with only `chatflowid` being strictly required.
* While `chatId` is technically optional in the request, providing it ensures the lead can be properly linked to the specific conversation that generated it.
* The implementation uses TypeORM's repository pattern for database operations.
* Generated fields (`id` and `createdDate`) are automatically managed by TypeORM and the database.
* The route is registered in the main router at `/api/v1/leads/`.
