# Development Guidelines for Remodl AI Platform (AI Agent Focus)

## 1. Project Overview

-   Rule: The Remodl AI Platform is the primary system being developed.
-   Rule: This platform utilizes a Flowise instance (currently based on upstream v2.2.8, on `remodel-v2-base` branch) as an embedded engine for AI flow design and execution.
-   Rule: Key external technologies for the Remodl AI Platform include Supabase (business logic, multi-tenancy data) and Zuplo (API Gateway).
-   Rule: AI development tasks must be understood within the context of enhancing the Remodl AI Platform. Flowise modifications should serve this higher-level goal and be minimized where possible by leveraging platform layers (Supabase, Zuplo, custom Remodl UI).
-   Rule: The project uses TypeScript as the primary language, with Node.js for the backend (Flowise server) and React for the frontend (Flowise UI and Remodl UI).

## 2. Project Architecture

-   Rule: The codebase is a PNPM monorepo with primary packages located under the `packages/` directory. Refer to `pnpm-workspace.yaml`.
-   Rule: Builds and development tasks are orchestrated by Turborepo. Refer to `turbo.json` for pipeline definitions (e.g., `build` outputs to `dist/**` folders within packages).
-   Rule: The main Remodl AI Platform user interface WILL BE developed in a new, dedicated package: `packages/remodl-ui` (exact name TBD by user, after server API documentation is complete). This package will be a React application.
    -   *Example (Do):* Create new UI components for Application Management within `packages/remodl-ui`.
    -   *Example (Don't):* Implement Remodl platform-specific dashboards directly within `packages/ui` without a clear strategy for separation or upstream compatibility.
-   Rule: The existing `packages/ui` (Flowise's standard UI, `name: flowise-ui`) serves as a reference and its core components (especially the flow canvas) MAY BE leveraged or embedded by `packages/remodl-ui`. Direct modifications to `packages/ui` should be minimized to facilitate easier upstream merges.
-   Rule: The Flowise backend is in `packages/server` (`name: flowise`). It's an Express.js application. Its APIs (prefixed `/api/v1`) are consumed by the Remodl platform, typically via the Zuplo API Gateway.
-   Rule: Strategic modifications to `packages/server` ARE PERMISSIBLE if well-designed for: a. Enhancing Flowise engine extensibility for Remodl (e.g., dynamic node loading). b. Introducing clean hooks/interception points for platform integrations. c. Robust propagation of Remodl-specific context. All such changes MUST be documented, justified, and designed for minimal upstream conflict. Modifications solely for Remodl business logic (that could reside in Supabase/Zuplo/custom nodes) MUST be avoided in `packages/server`.
-   Rule: Shared Flowise logic, node definitions, and interfaces reside in `packages/components` (`name: flowise-components`). Remodl-specific custom Flowise nodes (e.g., tools to interact with Supabase) MUST be developed within this package, following existing patterns for node creation.
-   Rule: Flowise's public API documentation is generated by `packages/api-documentation`. Internal API documentation for the Remodl platform (covering necessary Flowise internal routes and Remodl-specific endpoints via Zuplo) WILL BE created as a separate OpenAPI 3.1.0 specification (e.g., `remodl-flowise-internal-api-v1.yaml`).
-   Rule: Development environment: `pnpm dev` at root starts UI (Vite on e.g., :8080 with proxy to backend) and Server (Nodemon restarting Node.js server on e.g., :3000).
-   Rule: Production serving (standard Flowise): Server serves its API and static UI assets from `packages/ui/build`. For Remodl AI Platform, `packages/remodl-ui` will likely be served independently (e.g., CDN) and interact with the Zuplo API gateway.

## 3. Code Standards

### Formatting
-   Rule: All TypeScript (.ts, .tsx) and Markdown (.md) files MUST adhere to the project's Prettier configuration (defined in root `package.json`).
-   Rule: Run `pnpm format` prior to committing changes.

### Linting
-   Rule: All JavaScript/TypeScript code MUST pass ESLint checks (config: root `.eslintrc.js`).
-   Rule: Address all ESLint errors and warnings. Use `pnpm lint` / `pnpm lint-fix`.
-   Rule: Unused imports and variables MUST be removed (ESLint: `unused-imports` plugin).
-   Rule: `console.log()` calls SHOULD be avoided for production code. `console.info()`, `console.warn()`, `console.error()` MAY be used for AI agent development debugging. CI will error on `console.log()`.

### Naming Conventions
-   Rule: Variables and function names: `camelCase`.
-   Rule: Classes, React components (PascalCase for .jsx/.tsx files), enums, and type aliases: `PascalCase`.
-   Rule: For interfaces, prefer `IPascalCase` (e.g., `interface INodeData {}`) when defining interfaces for Flowise components and core structures. For general type definitions, `PascalCase` is also acceptable.
-   Rule: Filenames for .ts/.tsx files SHOULD generally match the name of the primary class/component/module they export, using `PascalCase.ts` or `PascalCase.tsx` for components/classes and `camelCase.ts` or `feature.service.ts` for services/utilities.
-   Rule: Strive for clear, descriptive, and unambiguous names for all identifiers.

### Commenting
-   Rule: Provide JSDoc-style comments (`/** ... */`) for all public-facing functions, classes, methods, and complex type definitions, especially within `packages/components` and shared utilities.
-   Rule: Use single-line (`//`) or block (`/* ... */`) comments to explain non-obvious logic, complex algorithms, or important decisions within code blocks.
-   Rule: Avoid redundant comments that merely restate what the code clearly does.
-   Rule: Mark items for future attention with `// TODO:` or `// FIXME:` prefixes.

### Error Handling (Server-side: `packages/server`)
-   Rule: Utilize `try...catch` blocks for operations that might fail.
-   Rule: When throwing custom errors, use or extend `InternalFlowiseError` from `src/errors/internalFlowiseError`, providing an appropriate `StatusCode` and descriptive message.
-   Rule: Service layer functions SHOULD throw errors; Controller layer functions SHOULD catch errors from services and format them or pass them to the global `errorHandlerMiddleware`.

### Logging (Server-side: `packages/server`)
-   Rule: Use the centralized Winston logger (`src/utils/logger`) for all server-side logging.
-   Rule: Use appropriate log levels (`error`, `warn`, `info`, `debug`).

### TypeScript Best Practices
-   Rule: Prioritize strong typing; avoid `any` where possible.
-   Rule: Use `async/await` for asynchronous operations.
-   Rule: Define interfaces/types close to usage or in shared `Interface.ts`/`types.ts` files within modules where appropriate.

### React Best Practices (`packages/ui`, `packages/remodl-ui`)
-   Rule: Use functional components with hooks.
-   Rule: Use PropTypes (.jsx) or TypeScript types/interfaces (.tsx) for prop validation.
-   Rule: Use `React.memo`, `useMemo`, `useCallback` judiciously for performance.
-   Rule: Consider existing state management patterns (Redux, Context API) for consistency or define a clear strategy if diverging.

## 4. Functionality Implementation Standards

-   Rule (Remodl Platform Features): New Remodl AI Platform-specific business logic (e.g., multi-tenancy, application management, user roles, feature flagging) MUST be implemented primarily within the Supabase backend. Flowise is an orchestrated engine.
-   Rule (Remodl UI Features): UI for Remodl Platform features MUST be in `packages/remodl-ui` (once created).
-   Rule (Integrating Remodl Logic into Flowise): Create custom nodes in `packages/components` to bridge Remodl platform data/logic (from Supabase via Zuplo) into Flowise flows.
    -   *Example (Do):* Custom tool "FetchRemodlUserDetails" calling Supabase via Zuplo.
    -   *Example (Don't):* Embed direct Supabase DB connections in `packages/server`.
-   Rule (Flowise Agent/Chatflow Development): When designing flows for Remodl Applications, utilize Flowise Agent Flow V2 capabilities.
-   Rule (API Design for Remodl Features): New API endpoints for Remodl Platform features (not direct Flowise operations) SHOULD be exposed via Zuplo, routing to Supabase or other Remodl services.

## 5. Framework/Plugin/Third-party Library Usage Standards

-   Rule (Dependency Management): Use PNPM (`pnpm install` from root). New dependencies/versions MUST be workspace-compatible.
-   Rule (Existing Frameworks - Flowise Core):
    -   Backend (`packages/server`): Express.js. New internal APIs (if essential) follow existing patterns. TypeORM for Flowise DB.
    -   Frontend (`packages/ui`, `packages/remodl-ui`): React, Vite. MUI is primary component library.
    -   AI/LLM Logic: Langchain.js is extensively used. Custom nodes SHOULD use Langchain primitives.
-   Rule (Adding New Major Libraries): Introducing new major libraries/frameworks requires architectural review and approval.
-   Rule (Version Pinning/Updates): AI Agent MUST NOT arbitrarily update library versions. Adhere to versions in `remodel-v2-base`.

## 6. Workflow Standards

-   Rule (Development): Use `pnpm dev` (from project root).
-   Rule (Building): Use `pnpm build` (from project root).
-   Rule (Branching): New Remodl AI Platform features MUST be on branches from `remodel-v2-base`.
-   Rule (Committing): Use clear, descriptive commit messages (Conventional Commits preferred if adopted by team).
-   Rule (Dependency Installation): Use `pnpm install` (from project root).

## 7. Key File Interaction Standards

-   Rule (Monorepo Configuration): Adding new packages requires updates to `pnpm-workspace.yaml`, root `package.json` (`workspaces`), and potentially `turbo.json`.
-   Rule (UI Package Naming): When `packages/ui` is duplicated for `packages/remodl-ui`, its internal `package.json` `name` field MUST be changed (e.g., `@remodl/ui`).
-   Rule (Server Route Registration): New `packages/server` API routes go in `src/routes/`, register in `src/routes/index.ts`. Controllers in `src/controllers/`, services in `src/services/`.
-   Rule (Component Registration - Flowise Nodes): New custom Flowise nodes for Remodl go in `packages/components/nodes/remodl/` (example path) and must be correctly exported/indexed.
-   Rule (Internal API Documentation): Document new/modified internal Flowise server APIs in `remodl-flowise-internal-api-v1.yaml` (OpenAPI 3.1.0).
-   Rule (Memory Bank Updates): Document significant architectural decisions, patterns, or task changes in Memory Bank files using MCP Memory Bank tools.

## 8. AI Decision-making Standards

-   Rule (Prioritize Remodl Layers): For new Remodl features: 1. Supabase logic. 2. Zuplo API. 3. `packages/remodl-ui`. 4. Custom Flowise nodes in `packages/components` as a bridge.
-   Rule (Minimize Flowise Core Changes): Direct modification of core Flowise files in `packages/server` (beyond approved extensibility points) or `packages/ui` (beyond theming/canvas integration) is a LAST RESORT. Justify if platform layers/custom nodes are insufficient.
-   Rule (Upstream Compatibility): Permissible Flowise core modifications MUST consider future merge compatibility with `FlowiseAI/Flowise` upstream. Aim for additive, clearly separated changes.
-   Rule (Tool Usage): AI Agent MUST use available MCP tools for context, progress tracking, and decision-making. Avoid assumptions.
-   Rule (Handling Ambiguity): If a task is ambiguous or conflicts with `rules.md`, use `process_thought` to analyze and propose resolution or seek clarification *before* implementation.

## 9. Prohibited Actions

-   Rule: DO NOT introduce breaking changes to the existing Flowise public API contracts (`packages/api-documentation/src/yml/swagger.yml`) without explicit directive.
-   Rule: DO NOT commit sensitive information (API keys, secrets) directly into the codebase.
-   Rule: DO NOT significantly alter the core build system (`turbo.json`, root `pnpm` scripts, Vite/TSC configs for core Flowise packages) without architectural approval.
-   Rule: DO NOT embed Remodl-specific business logic directly into `packages/server` if it can be housed in Supabase and accessed via platform APIs.
-   Rule: DO NOT introduce new core dependencies to Flowise packages (`server`, `ui`, `components`) without impact analysis. Prefer adding dependencies to `packages/remodl-ui` for custom platform UI features.